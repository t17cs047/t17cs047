
<form method="post" action="{% url 'write' %}" >{% csrf_token %}
<div id = "comment" hidden>以下の内容で保存します</div>
<div id = "forms">
	<div id = date>
	{{form.as_p}}
	</div>
{% if messages %}
	<ul class="messages">
		{% for message in messages %}
			<li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
		{% endfor %}
	</ul>
{% endif %}
<div id="form_set">
		{{ formset.management_form }}
		{{ activityformset.management_form }}
		{% for activity_form in formset %}
            <table class='no_error'>
            {{ activity_form}}
            <hr id="section_line">
            </table>
       {% endfor %}
</div>
<hr>
</div>
<input type="button" value="行を追加する" id="add_more">
<input type="button" value="行を一行削除する" id="decline" >
<div id="empty_form" style="display:none">
<hr>
<table class='no_error'>
	 {{ formset.empty_form.as_table }}
</table>
</div>  
	<div id = review_area></div>
			<input type="button" id="confirm" value="confirm" class="def">
			<input type="button" id="revise" value=revise" hidden >
			<input type="submit" id = "submit" hidden/>
          </form>
          <a href="{% url 'index' %}">index</a>	
	
	
	
	
	 <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/timedropper/1.0/timedropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/timedropper/1.0/timedropper.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script>
        $('#add_more').click(function() {
             var form_idx = $('#id_activity_set-TOTAL_FORMS').val();		      
		      var option = $('#id_activity_set-0-project').children().clone();
		      var optionCount = $('#id_activity_set-0-project').children().length;
		      var str = "id_activity_set-" + form_idx + "-project";
		      $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
             $('#id_activity_set-TOTAL_FORMS').val(parseInt(form_idx) + 1);
             $('[id $= "time" ]').timeDropper({
              format: "H:mm",
              setCurrentTime: false,
          });
				var i = 0;
				$('#' + str).children().remove();
				$('#' + str).append(option);
	
	
           });
      </script>

    <script>
        $('#decline').click(function() {
             var form_idx = $('#id_activity_set-TOTAL_FORMS').val();
             if(form_idx > 1){
             		console.log(form_idx);
             		var num = form_idx - 1;
             		console.log(num);
           	  	var str = $('.no_error').eq(form_idx);
             		$('.no_error').eq(form_idx - 1).remove();
             		$('hr').eq(form_idx - 1).remove();	      
             		$('#id_activity_set-TOTAL_FORMS').val(parseInt(form_idx) - 1);
             }
           });
      </script>
			<p hidden>are you sure?<p>
			<input type="button" id="confirm" value="confirm" class="def">
			<input type="button" id="revise" value=revise" hidden >
			<input type="submit" id = "submit" hidden/>
          </form>
          <a href="{% url 'index' %}">メニューに戻る</a>
          
<script>
        $('#confirm').click(function() {
        		console.log(confirm);
        		var form_idx = $('#id_activity_set-TOTAL_FORMS').val();			
				var num = $('#id_activity_set-TOTAL_FORMS').val();
  				var start_array = [];
  				var end_array = [];
  				var all_del = true;
  				for( var i = 0; i < num ; i++){
  					var str1 = "id_activity_set-" + i + "-start_time";
  					var str2 = "id_activity_set-" + i + "-end_time";
  					var str3 = "id_activity_set-" + i + "-DELETE";
  					
  					start_array.push($('#' + str1).val());
  					end_array.push($('#' + str2).val());
					if(start_array[i].charAt(1)==":")
  						start_array[i]= '0' + start_array[i]; 
  					if(end_array[i].charAt(1)==":")
  						end_array[i]= '0' + end_array[i]; 
  					if(start_array[i] >= end_array[i]){
  						alert("the start_time is ahead of the end_time");
  						console.log(start_array[i]);
  						console.log(end_array[i]);
  						return false;
  					}
  					console.log($('#' + str3).prop('checked'));
  					if(! $('#' + str3).prop('checked') ){  						
  						all_del = false;
  						}
  				}
  				
  				if(all_del){
  					alert("there is no report to register");
  					return false;
				}  				
				for(var i = 0; i < num - 1; i++ ){
					for( var  j = i + 1; j < num; j++){
						if(start_array[i] <= end_array[j] && end_array[i] >= start_array[j]){
							alert("overlap of the time");					
							return false;
						}else{
							//do nothing
						}
					}		
				}				
				/*----type2----*/
				$('[id = add_more]').hide();
				$('[id = decline]').hide();
				$('[id = confirm]').hide();
				$(submit).show();
				$('[id = revise]').show();
				str0 = $('#id_date').val();
				var text = "date" + str0 +"br" +"<hr>";
				for(var i=0; i<form_idx; i++){
					var str1 = "#id_activity_set-" + i + "-start_time";
  					var str2 = "#id_activity_set-" + i + "-end_time";
  					var str3 = "#id_activity_set-" + i + "-project";
  					var str4 = "#id_activity_set-" + i + "-memo";
  					var str5 = "#id_activity_set-" + i + "-DELETE";
  					str1 = $(str1).val();
  					str2 = $(str2).val();
  					str3 = $("option:selected",str3).text();
  					str4 = $(str4).val();
  					if(! $(str5).prop('checked') ) 					
  						text = text + "start time: " + str1 + "br" + "end time: " + str2 + "br" + "project: " + str3 + "br" + "memo:" + str4 + "<hr>";
  					console.log(text);
				}
				$('[id="review_area"]').show();
				console.log("call");
				$('[id="review_area"]').empty();
				$('[id="review_area"]').append(text.replace(/br/g, '<br>'));
				$('[id = form_set]').hide();
				$('[id = date]').hide();
				$('[id = comment]').show();
				
				/*----type2----*/
           });
</script>
          
<script>
        $('#revise').click(function() {
        		$('[id = add_more]').show();
				$('[id = decline]').show();
				$('[id = confirm]').show();
				$(submit).hide();
				$('[id = revise]').hide();
				$('[id="review_area"]').hide();
				$('[id = form_set]').show();
				$('[id = date]').show();
				$('[id = comment]').hide();
        	}
        	);
</script>          
          
                  
 <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/timedropper/1.0/timedropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/timedropper/1.0/timedropper.min.js"></script>
    <script>
      $(function () {
          $('[id $= "time" ]').timeDropper({
              format: "H:mm",
              setCurrentTime: false,
          });
      });
  </script>
  <script>
  $('form').submit(function(){		
		/*----type1----
		       $('[id $= "time" ]').prop("disabled",false);
				$('[id $= "project" ]').prop("disabled",false);
				$('[id $= "memo" ]').prop("disabled",false);
				$('[id $= "date" ]').prop("disabled",false);
		-----*/
		return true;
  		});
  </script>
  
             
   